<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zhihua Temple Interactive Exhibition</title>
    <style>
        :root {
            --gold: #d4af37; --bg: #121212; --panel: #fdfdfd;
            --sickman: #2c3e50; --liu: #27ae60; --shen: #8e44ad; --wang: #c0392b;
        }
        body { 
            margin: 0; padding: 0; background: var(--bg); color: #e0d8c3; 
            font-family: 'Hoefler Text', 'Noto Serif SC', 'Noto Serif TC', serif; 
            overflow: hidden; display: flex; flex-direction: column; align-items: center; 
        }
        
        #game-view {
            position: relative; width: 1507px; height: 765px;
            background: url('Hong Kong Exhibiton Schematic Layout_V4.png') no-repeat;
            background-size: contain; border: 4px solid #333;
            transform: scale(0.8); transform-origin: top center; margin-top: 20px;
        }
        
        #player {
            position: absolute; width: 34px; height: 34px; background: #e74c3c;
            border: 3px solid white; border-radius: 50%; z-index: 10;
            box-shadow: 0 0 15px rgba(0,0,0,0.5); top: 700px; left: 1300px;
            display: flex; justify-content: center; align-items: center;
            transition: top 0.05s linear, left 0.05s linear;
        }
        
        #interact-btn {
            position: absolute; display: none; background: var(--gold); color: black;
            border: none; padding: 10px 20px; border-radius: 20px; font-weight: bold;
            cursor: pointer; z-index: 20; top: -60px; left: 50%; transform: translateX(-50%);
            white-space: nowrap; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 100; }
        .content-box { background: var(--panel); color: #333; width: 90%; max-width: 800px; padding: 40px; border-radius: 6px; position: relative; border-top: 8px solid var(--gold); box-shadow: 0 20px 50px rgba(0,0,0,0.8); }
        .media-box { width: 100%; aspect-ratio: 16/9; background: #000; margin-bottom: 15px; }
        iframe { width: 100%; height: 100%; border: none; }
        .close-x { position: absolute; top: -50px; right: 0; background: #e74c3c; color: white; border: none; padding: 10px 20px; cursor: pointer; font-weight: bold; }

        .speaker { font-weight: bold; margin-bottom: 5px; text-transform: uppercase; color: #555; font-size: 0.95em; }
        .dialogue { font-size: 1.25em; line-height: 1.6; margin-bottom: 25px; min-height: 80px; }
        .inner { font-style: italic; color: #666; border-left: 3px solid #ddd; padding-left: 15px; }
        .choices { display: flex; flex-direction: column; gap: 10px; }
        .btn-choice { background: #f5f5f5; border: 1px solid #ccc; padding: 15px; border-radius: 6px; cursor: pointer; font-size: 1.05em; transition: 0.2s; }
        .btn-choice:hover { background: #e0e0e0; border-color: #555; }
        .btn-nav { background: #333; color: white; border: none; padding: 12px 35px; border-radius: 4px; cursor: pointer; float: right; font-weight: bold; }

        #d-pad { position: fixed; bottom: 30px; right: 30px; display: grid; grid-template-columns: 50px 50px 50px; grid-template-rows: 50px 50px 50px; gap: 5px; z-index: 50; }
        .pad-btn { background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.5); color: white; font-weight: bold; border-radius: 8px; cursor: pointer; user-select: none; }
        .pad-btn:active { background: rgba(255,255,255,0.5); }
        #up-btn { grid-column: 2; grid-row: 1; }
        #left-btn { grid-column: 1; grid-row: 2; }
        #down-btn { grid-column: 2; grid-row: 2; }
        #right-btn { grid-column: 3; grid-row: 2; }

        #start-screen { position: fixed; top:0; left:0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; cursor: pointer; }
        #start-screen h1 { margin-bottom: 10px; color: var(--gold); }
        #start-screen p { margin-bottom: 30px; color: #ccc; }
        .start-btn { background: var(--gold); color: black; border: none; padding: 15px 40px; font-size: 1.2em; font-weight: bold; border-radius: 30px; cursor: pointer; }

        #debug { position: fixed; top: 10px; left: 10px; background: rgba(0,0,0,0.7); font-size: 12px; padding: 5px; pointer-events: none; }
    </style>
</head>
<body>

<div id="debug">X: 1300, Y: 700</div>

<div id="start-screen" onclick="startGame()">
    <h1>Zhihua Temple Exhibition</h1>
    <p>Use WASD or Arrow Keys to Move.</p>
    <button class="start-btn">Click to Start</button>
</div>

<div id="game-view">
    <div id="player"><button id="interact-btn" onclick="executeInteraction()">Interact</button></div>
</div>

<div id="d-pad">
    <button class="pad-btn" id="up-btn" onmousedown="startMove('up')" onmouseup="stopMove('up')" onmouseleave="stopMove('up')" ontouchstart="startMove('up')" ontouchend="stopMove('up')">W</button>
    <button class="pad-btn" id="left-btn" onmousedown="startMove('left')" onmouseup="stopMove('left')" onmouseleave="stopMove('left')" ontouchstart="startMove('left')" ontouchend="stopMove('left')">A</button>
    <button class="pad-btn" id="down-btn" onmousedown="startMove('down')" onmouseup="stopMove('down')" onmouseleave="stopMove('down')" ontouchstart="startMove('down')" ontouchend="stopMove('down')">S</button>
    <button class="pad-btn" id="right-btn" onmousedown="startMove('right')" onmouseup="stopMove('right')" onmouseleave="stopMove('right')" ontouchstart="startMove('right')" ontouchend="stopMove('right')">D</button>
</div>

<div id="diag-overlay" class="overlay">
    <div id="diag-box" class="content-box">
        <button class="close-x" onclick="closeAll()">CLOSE [X]</button>
        <div id="diag-speaker" class="speaker">System</div>
        <div id="diag-text" class="dialogue">Select Language</div>
        <div id="diag-choices" class="choices"></div>
        <div style="overflow: hidden; margin-top: 20px;">
            <button id="diag-next" class="btn-nav" style="display:none;" onclick="handleNext()">Next</button>
        </div>
    </div>
</div>

<div id="media-overlay" class="overlay">
    <div class="content-box" style="background: #222; padding: 20px; border-top:none;">
        <button class="close-x" onclick="closeAll()">CLOSE [X]</button>
        <div class="media-box"><iframe id="media-frame" src=""></iframe></div>
        <div id="media-nav" style="text-align: center; display: none;">
            <button id="media-next-btn" class="btn-nav" style="float: none; background: var(--gold); color: black;" onclick="handleMediaNext()">Next</button>
        </div>
    </div>
</div>

<script>
    function startGame() {
        document.getElementById('start-screen').style.display = 'none';
        isInteracting = false;
        window.focus(); 
        requestAnimationFrame(frame);
    }

    const hotspots = [
        { id: 'wanfo_seq', name: "萬佛互動", x: 880, y: 110, type: 'seq' },
        { id: 'wanfo_model', name: "萬佛閣木質模型", x: 730, y: 110, type: 'media', url: "https://drive.google.com/file/d/12JiujhF0TBlKAlH5ln36IL5BE_bf0byh/preview" },
        { id: 'soundscape', name: "聲景視頻", x: 150, y: 110, type: 'seq' },
        { id: 'ceiling_3d', name: "3D打印藻井互動", x: 100, y: 500, type: 'external' }, 
        { id: 'sickman', name: "史克門敘事碑", x: 840, y: 600, type: 'diag' },
        { id: 'liu', name: "劉敦楨敘事碑", x: 650, y: 600, type: 'diag' },
        { id: 'shen', name: "沈廷芳敘事碑", x: 460, y: 600, type: 'diag' },
        { id: 'wang', name: "王振敘事碑", x: 270, y: 600, type: 'diag' }
    ];

    const scripts = {
        sickman: {
            en: {
                "1": ["Laurence Sickman", "Good day. You seem to have come from afar. What brings you here today?", "2"],
                "2": ["choice", ["a) I am here to see an exhibition", "b) I am seeking pathways to wisdom"], {a: "3a", b: "3b"}],
                "3a": ["Laurence Sickman", "Then we meet on familiar ground. For many years I served as a curator at the Nelson-Atkins Museum of Art.", "4"],
                "3b": ["Laurence Sickman", "Hmm, you may even help me with a question that has followed me for years. For many years I served as curator at the Nelson-Atkins Museum of Art.", "4"],
                "4": ["Laurence Sickman", "Have you seen our Chinese Temple Room Gallery?", "5"],
                "5": ["choice", ["a) This if my first time seeing this", "b) Yes, I have been to this place"], {a: "6", b: "6"}],
                "6": ["Laurence Sickman", "That gallery occupies a special place in my heart. The mural came from Guangsheng Temple in Shanxi. The coffered ceiling—what you see overhead—came from Zhihua Temple in Beijing.", "7"],
                "7": ["Laurence Sickman", "I brought them to Kansas City in the 1930s.", "8"],
                "8": ["Laurence Sickman", "At the time, I had only just finished my training as an art historian. A Harvard–Yenching Fellowship allowed me to live in Beijing and continue my studies.", "9"],
                "9": ["Laurence Sickman", "It was then that my former teacher, Landon Warner, wrote to me.", "10"],
                "10": ["Laurence Sickman", "He showed me a photograph published alongside an article by Liu Dunzhen, the architectural historian.", "11"],
                "11": ["Laurence Sickman", "The ceiling had already been taken down from Zhihua Temple—a Ming-dynasty Buddhist monastery not far from where I lived—and it was now being offered for sale.", "12"],
                "12": ["Laurence Sickman", "Warner believed it would be an ideal acquisition for a new museum under construction in Kansas City.", "13"],
                "13": ["Laurence Sickman", "So I followed whispers and addresses through the city: antique shops, back rooms, introductions; long conversations with dealers; and, inevitably, a great deal of tea.", "14"],
                "14": ["Laurence Sickman", "At last, the trail led to a modest courtyard near a coffin shop. There, in front of the displaced ceiling, I negotiated the price and made an agreement.", "15"],
                "15": ["Laurence Sickman", "Afterward, I went to Zhihua Temple to understand what, precisely, had been removed.", "16"],
                "16": ["Laurence Sickman", "I will never forget the room where the ceiling once belonged: walls covered with thousands of small seated Buddhas, like the stars in the cosmo.", "17"],
                "17": ["Laurence Sickman", "Years have passed, and yet I keep returning to that room in my sleep, as though a part of me never quite left it.", "18"],
                "18": ["Laurence Sickman", "Follow the lines on the floor. They will lead you to the first dream. There, you may help me see what I could not.", null]
            },
            zh: {
                "1": ["史克門", "有失遠迎，是什麼風把您吹來了？", "2"],
                "2": ["choice", ["a) 我今天來看個展覽。", "b) 我在尋找通往智慧之路。"], {a: "3a", b: "3b"}],
                "3a": ["史克門", "那我們算是有共同話題了。我以前在納爾遜·阿特金斯美術館當了很多年策展人。", "4"],
                "3b": ["史克門", "嗯...說不定您能幫我解一個困擾我多年的問題。我以前在納爾遜·阿特金斯美術館當了很多年策展人。", "4"],
                "4": ["史克門", "您去過我們的中國廟宇展廳嗎？", "5"],
                "5": ["choice", ["a) 這是我第一次看到。", "b) 我去過那個地方。"], {a: "6", b: "6"}],
                "6": ["史克門", "這個廳對我來說由特殊的意義。牆上的壁畫來自山西廣勝寺，頭頂上的藻井來自北京智化寺。", "7"],
                "7": ["史克門", "是我在1930年代把它們帶到堪薩斯城的。", "8"],
                "8": ["史克門", "那時候我剛大學畢業，拿哈佛燕京學社的獎學金住在北平繼續做研究中國藝術。", "9"],
                "9": ["史克門", "有一天，我以前的老師蘭登·華爾納寫信給我。", "10"],
                "10": ["史克門", "他給我看了一張照片，是建築史學家劉敦楨文章裡附的。", "11"],
                "11": ["史克門", "智化寺是一座明代的佛寺，離我住的地方不遠。那時候藻井已經被拆下來了，正在找買主。", "12"],
                "12": ["史克門", "華爾納覺得，堪薩斯城正在蓋一座新的博物館，這件藻井非常合適成爲其收藏。", "13"],
                "13": ["史克門", "於是我們在北平一路追蹤線索：頻繁光顧琉璃廠的古董店、到處打聽、請人介紹、在漫長的對話中喝了無數杯茶。", "14"],
                "14": ["史克門", "最後循線找到一個小院子，隔壁還是家棺材鋪。就在那個院子裡，藻井就擺在我眼前。我當場談好價錢，把事情定下來。", "15"],
                "15": ["史克門", "之後我去了智化寺一趟，想看清楚——這個藻井原來是裝在哪裡的。", "16"],
                "16": ["史克門", "我永遠不會忘記那個房間：牆上滿滿是數千尊小小的坐佛，像夜空裡的星星。", "17"],
                "17": ["史克門", "這麼多年過去了，我還是常常夢見那個房間。好像我的一部分，從來沒有真正離開過。", "18"],
                "18": ["史克門", "請跟著地上的線走。它會引導您到第一場夢。在那裡，或許您能幫我看看——我當年沒能看清的事。", null]
            },
            sc: {
                "1": ["史克门", "有失远迎，是什么风把您吹来了？", "2"],
                "2": ["choice", ["a) 我今天来看个展览。", "b) 我在寻找通往智慧之路。"], {a: "3a", b: "3b"}],
                "3a": ["史克门", "那我们算是有共同话题了。我以前在纳尔逊·阿特金斯美术馆当了很多年策展人。", "4"],
                "3b": ["史克门", "嗯...说不定您能帮我解一个困扰我多年的问题。我以前在纳尔逊·阿特金斯美术馆当了很多年策展人。", "4"],
                "4": ["史克门", "您去过我们的中国庙宇展厅吗？", "5"],
                "5": ["choice", ["a) 这是我第一次看到。", "b) 我去过那个地方。"], {a: "6", b: "6"}],
                "6": ["史克门", "这个厅对我有特殊的意义。墙上的壁画来自山西广胜寺，头顶上的藻井来自北京智化寺。", "7"],
                "7": ["史克门", "是我在1930年代把它们带到堪萨斯城的。", "8"],
                "8": ["史克门", "那时候我刚大学毕业，拿哈佛燕京学社的奖学金住在北平继续做研究中国艺术。", "9"],
                "9": ["史克门", "有一天，我以前老师兰登·华尔纳写信给我。", "10"],
                "10": ["史克门", "他给我看了一张照片，是建筑史学家刘敦桢文章里附的。", "11"],
                "11": ["史克门", "智化寺是一座明代的佛寺，离我住的地方不远。那时候藻井已经被拆下来了，正在找买主。", "12"],
                "12": ["史克门", "华尔纳觉得，堪萨斯城正在盖一座新的博物馆，这件藻井非常合适成为其收藏。", "13"],
                "13": ["史克门", "于是我们在北平一路追踪线索：频繁光顾琉璃厂的古董店、到处打听、请人介绍、在漫长的对话中喝了无数杯茶。", "14"],
                "14": ["史克门", "最后循线找到一个小院子，隔壁还是家棺材铺。就在那个院子里，藻井就摆在我眼前。我当场谈好价钱，把事情定下来。", "15"],
                "15": ["史克门", "之后我去了智化寺一趟，想看清楚——这个藻井原来是装在哪里的。", "16"],
                "16": ["史克门", "我永远不会忘记那个房间：墙上满满是数千尊小小的坐佛，像夜空里的星星。", "17"],
                "17": ["史克门", "这么多年过去了，我还是常常梦见那个房间。好像我的一部分，从来没有真正离开过。", "18"],
                "18": ["史克门", "请跟着地上的线走。它会引导您到第一场梦。在那里，或许您能帮我看——我当年没能看清的事。", null]
            }
        },
        liu: {
            en: {
                "1": ["Liu Dunzhen", "You look a bit puzzled—can I help?", "2"],
                "2": ["Visitor", "Hello. I came to see the exhibition… but I think I just dreamed of a Buddhist hall. In the dream, I became one of the tiny Buddhas on the wall.", "3"],
                "3": ["Liu Dunzhen", "(chuckles) An exhibition? This is the Wanfo Pavilion of Zhihua Temple, is it not?", "4"],
                "4": ["Visitor", "(inner thought): How did I end up at Zhihua Temple? And who is this person…?", "5"],
                "5": ["Liu Dunzhen", "Lately, more and more people have been coming to Zhihua Temple. Just yesterday I met a young American named Sickman. He’s quite perceptive about Chinese art.", "6"],
                "6": ["Visitor", "(inner thought): Suddenly I remember: when I was speaking with Sickman earlier, he mentioned a scholar who studies the history of Chinese architecture…", "7"],
                "7": ["Visitor", "Excuse me—are you Professor Liu Dunzhen?", "8"],
                "8": ["Liu Dunzhen", "I am. This time I’ve brought my students from Nanjing to Beijing, mainly to conduct field studies of the city’s historic architecture.", "9"],
                "9": ["Liu Dunzhen", "I’ve long been fascinated by Zhihua Temple. It is not only among the oldest surviving official-style timber complexes in the city, but it also integrates elements of Tibetan Buddhist and Pure Land traditions—everywhere you look, there is something to ponder.", "10"],
                "10": ["Visitor", "Could you tell me more?", "11"],
                "11": ["Liu Dunzhen", "Take the Wanfo Pavilion where we stand, for example. The lower level is called the Tathāgata Hall. It enshrines Śākyamuni Buddha and also houses Buddhist scriptures printed by the Ming imperial court—symbols of a kind of wisdom that can be reached in the human world.", "12"],
                "12": ["Liu Dunzhen", "The upper level, meanwhile, enshrines the “Buddhas of the Three Bodies.” At the center is Vairocana—the Dharma-body Buddha—representing the Buddha’s teaching as an abstract truth, something one can only realize through understanding the canon.", "13"],
                "13": ["Liu Dunzhen", "Above Vairocana, there was once a coffered ceiling, carved with nine dragons and the Eight Auspicious Symbols of Tibetan Buddhism. All around it, the surrounding ceiling was filled with mandala-like spells—together guarding this pure Buddha-land.", "14"],
                "14": ["Liu Dunzhen", "Scriptures below, the Dharma-body above, and the coffered ceiling in between as a protective canopy—this building formed a complete space of faith. But sadly, the coffered ceiling has been dismantled and sold. I have no idea where it has drifted to now…", "15"],
                "15": ["choice", ["a) Tell Liu Dunzhen that the coffered ceiling is now at the Nelson-Atkins Museum of Art in Kansas City.", "b) Remain silent."], {a: "16", b: "16"}],
                "16": ["Liu Dunzhen", "(sighs deeply) I only hope that one day it may see the light again. If Shen Tingfang had not submitted his memorial, perhaps Zhihua Temple would not have fallen into such decline.", "17"],
                "17": ["Liu Dunzhen", "If we don’t act quickly, we may lose this precious cultural heritage forever.", "18"],
                "18": ["Liu Dunzhen", "My students and I are surveying Zhihua Temple, and we plan to build a wooden sectional model of the Tathāgata Hall and the Wanfo Pavilion. Would you be willing to lend us a hand?", "19"],
                "19": ["Visitor", "Of course.", "20"],
                "20": ["Liu Dunzhen", "Wonderful—thank you! Please follow the lines on the floor; they will lead you to our temporary studio. We’d very much like to hear your thoughts on the model once you arrive.", null]
            },
            zh: {
                "1": ["劉敦楨", "您看起來有些疑惑，需要我幫忙嗎？", "2"],
                "2": ["觀眾", "您好，我本來是來看展覽的。剛剛好像夢見了一座佛殿，我變成牆壁上的一尊小佛。", "3"],
                "3": ["劉敦楨", "您說笑了，哪裡有展覽？這裡不就是智化寺的萬佛閣嗎？", "4"],
                "4": ["觀眾", "（內心：我怎麼會來到智化寺？眼前的這位又是？）", "5"],
                "5": ["劉敦楨", "最近來智化寺的人愈發多了。昨天我還遇到一位美國來的年輕人，名叫史克門，他對中國藝術頗有見解。", "6"],
                "6": ["觀眾", "（內心：忽然想起，剛才與史克門交談時，他提到過一位研究中國建築史的學者）", "7"],
                "7": ["觀眾", "請教一下，您莫非是劉敦楨教授？", "8"],
                "8": ["劉敦楨", "正是在下。此次我帶著學生從南京來到北平，主要想實地考察城中的古建築。", "9"],
                "9": ["劉敦楨", "我對智化寺一直很感興趣。它不僅是城內歷史最悠久的官式木構建築，更融合了藏傳佛教與淨土信仰的風格，處處耐人尋味。", "10"],
                "10": ["觀眾", "可以請您多講講嗎？", "11"],
                "11": ["劉敦楨", "就以我們所在的萬佛閣為例吧。樓下這層叫如來殿，供奉釋迦牟尼佛，還藏有明代宮廷刊刻的佛經，象徵著世間可以觸及的佛法智慧。", "12"],
                "12": ["劉敦楨", "而樓上這層，供奉的是“三身佛”。正中是毗盧佛，為“法身佛”，代表佛法作為抽象真理的存在，須透過理解經藏才能體悟。", "13"],
                "13": ["劉敦楨", "在毗盧佛上方，原本有一座藻井，雕有九龍與藏傳佛教的八種吉祥物，四周更滿佈曼荼羅法咒的天花，共同守護著這片佛國淨土。", "14"],
                "14": ["劉敦楨", "經藏在下、法身在上，藻井居中護持——整座建築因而形成一個完整的信仰空間。可惜的是，藻井已被拆賣，不知如今流落何方……", "15"],
                "15": ["choice", ["a) 告訴劉敦楨藻井在堪薩斯城的納爾遜·阿特金斯藝術博物館。", "b) 保持沈默。"], {a: "16", b: "16"}],
                "16": ["劉敦楨", "原來如此…（長嘆）希望有朝一日，它能重見光明。若不是當年沈廷芳一紙奏摺，智化寺或可避此劫難。", "17"],
                "17": ["劉敦楨", "若不趕緊行動，我們恐怕將永遠失去這份珍貴的文化遺產。", "18"],
                "18": ["劉敦楨", "我與學生正著手測繪智化寺，計劃製作一個如來殿-萬佛閣的木構剖面模型。不知您是否願意助我們一臂之力？", "19"],
                "19": ["觀眾", "當然願意。", "20"],
                "20": ["劉敦楨", "太好了，感謝您！請沿著地上的標線走，它會帶您到我們臨時的工作室。在那裡，我們很希望能聽聽您對模型的建議。", null]
            },
            sc: {
                "1": ["刘敦桢", "您看起来有些疑惑，需要我帮忙吗？", "2"],
                "2": ["观众", "您好，我本来是来看展览的。刚刚好像梦见了一座佛殿，我变成墙壁上的一尊小佛。", "3"],
                "3": ["刘敦桢", "您说笑了，哪里有展览？这里不就是智化寺的万佛阁吗？", "4"],
                "4": ["观众", "（内心：我怎么会来到智化寺？眼前的这位又是？）", "5"],
                "5": ["刘敦桢", "最近来智化寺的人愈发多了。昨天我还遇到一位美国来的年轻人，名叫史克门，他对中国艺术颇有见解。", "6"],
                "6": ["观众", "（内心：忽然想起，刚才与史克门交谈时，他提到过一位研究中国建筑史的学者）", "7"],
                "7": ["观众", "请教一下，您莫非是刘敦桢教授？", "8"],
                "8": ["刘敦桢", "正是在下。此次我带着学生从南京来到北平，主要想实地考察城中的古建筑。", "9"],
                "9": ["刘敦桢", "我对智化寺一直很感兴趣。它不仅是城内历史最悠久的官式木构建筑，更融合了藏传佛教与净土信仰的风格，处处耐人寻味。", "10"],
                "10": ["观众", "可以请您多讲讲吗？", "11"],
                "11": ["刘敦桢", "就以我们所在的万佛阁为例吧。楼下这层叫如来殿，供奉释迦牟尼佛，还藏有明代宫廷刊刻的佛经，象征着世间可以触及的佛法智慧。", "12"],
                "12": ["刘敦桢", "而楼上这层，供奉的是“三身佛”。正中是毗卢佛，为“法身佛”，代表佛法作为抽象真理的存在，须通过理解经藏才能体悟。", "13"],
                "13": ["刘敦桢", "在毗卢佛上方，原本有一座藻井，雕有九龙与藏传佛教的八种吉祥物，四周更布满曼荼罗法咒的天花，共同守护着这片佛国净土。", "14"],
                "14": ["刘敦桢", "经藏在下、法身在上，藻井居中护持——整座建筑因而形成一个完整的信仰空间。可惜的是，藻井已被拆卖，不知如今流落何方……", "15"],
                "15": ["choice", ["a) 告诉刘敦桢藻井在堪萨斯城的纳尔逊·阿特金斯艺术博物馆。", "b) 保持沉默。"], {a: "16", b: "16"}],
                "16": ["刘敦桢", "原来如此……（长叹）希望有朝一日，它能重见光明。若不是当年沈廷芳一纸奏折，智化寺或可避此劫难。", "17"],
                "17": ["刘敦桢", "若不赶紧行动，我们恐怕将永远失去这份珍贵的文化遗产。", "18"],
                "18": ["刘敦桢", "我与学生正着手测绘智化寺，计划制作一个如来殿-万佛阁的木构剖面模型。不知您是否愿意助我们一臂之力？", "19"],
                "19": ["观众", "当然愿意。", "20"],
                "20": ["刘敦桢", "太好了，感谢您！请沿着地上的标线走，它会带您到我们临时的工作室。在那里，我们很希望能听听您对模型的建议。", null]
            }
        },
        shen: {
            en: {
                "1": ["Visitor", "(inner thought): Sounds like someone nearby is reciting a poem.", "2"],
                "2": ["Shen Tingfang", "“Ten thousand folds of western hills embrace the imperial blue. / From this tower, one gaze—and clouds sink deep and dim.”", "3"],
                "3": ["Shen Tingfang", "“The vast sky and falling sun stretch boundless, far from sight. / Ere autumn yet is come, the frontier geese reach Northern court.”", "4"],
                "4": ["Shen Tingfang", "(With a soft sigh) The autumn air in the capital is crisp and clear—perfect for climbing high and gazing into the distance. What a pity... there's no kindred spirit to share this view.", "5"],
                "5": ["Visitor", "(inner thought): I once learnt a poem… should I not answer him in kind?", "6"],
                "6": ["Visitor", "“By the sandy riverbank, lantern-lights dye the hills a ruddy glow. / Songs and drum resound—amid laughter and bright talk.”", "7"],
                "7": ["Visitor", "“Tell me now—doth the youth’s heart yet remain? / With my cap sits askew, my sideburn hairs are like wind-toss’d weed.”", "8"],
                "8": ["Shen Tingfang", "(Clapping hand) Marvelous! These lines are Master Dongpo’s (Su Shi)—written when he journyed to Hangzhou to serve as examiner, and, climbing the Wanghai Tower on Phoenix Hill.", "9"],
                "9": ["Shen Tingfang", "I too am from Hangzhou. In my youth, I aspired to learning, with a particular passion for poetry. By the grace of the Emperor, I entered the Hanlin Academy in the capital to compile the History of the Ming Dynasty, studying the rise and fall of rulers and ministers from previous eras.", "10"],
                "10": ["Shen Tingfang", "Later, I was sent to Shandong to serve as Investigating Censor, overseeing disaster relief efforts. Recently, official business brought me back to the capital, so I seized the chance to visit historic sites and explore scenic spots.", "11"],
                "11": ["Visitor", "(inner thought): Mayhap he holds some clue to Zhihua Temple…", "12"],
                "12": ["Visitor", "I also enjoy visiting historic sites. Might I ask, sir, have you ever heard of Zhihua Temple?", "13"],
                "13": ["Shen Tingfang", "I visited Zhihua Temple just a few days ago, and to my astonishment, there stood a wooden effigy of Wang Zhen inside. The common people, ignorant of the truth, were bowing and paying homage to him—truly heartbreaking!", "14"],
                "14": ["Shen Tingfang", "So I submitted a memorial to the Qianlong Emperor, requesting that the effigy be removed and the inscriptions be smashed, to correct public perception and uphold righteousness.", "15"],
                "15": ["Visitor", "(inner thought): So this is Shen Tingfang, the Qing dynasty censor who changed Zhihua Temple's fate!", "16"],
                "16": ["Visitor", "My learning is shallow and I am unfamiliar with these past events. I would be honored to receive your instruction.", "17"],
                "17": ["Shen Tingfang", "Wang Zhen was a eunuch of the Ming dynasty, a devout believer in Buddhism. He donated his residence to build Zhihua Temple, and also used it to honor his ancestors.", "18"],
                "18": ["Shen Tingfang", "Wang Zhen enjoyed great favor from Emperor Yingzong, but later abused his power and misled the state. During the Tumu Crisis of 1449, he commanded poorly, leading to the complete annihilation of the Ming army and his own death amidst the chaos.", "19"],
                "19": ["Shen Tingfang", "Since ancient times, when eunuchs seize power, the people suffer. And now, the incense at Zhihua Temple still burns bright—is this not a great injustice of history?", "20"],
                "20": ["choice", ["a) Agree with Shen Tingfang; condemn Wang Zhen.", "b) May I ask, sir, have you considered the impact your actions might have on Zhihua Temple?"], {a: "21a", b: "21b"}],
                "21a": ["Shen Tingfang", "Great minds think alike. Taking history as a mirror—that is precisely our generation's responsibility.", "22"],
                "21b": ["Shen Tingfang", "The temple itself bears no fault, yet it is inevitably affected. If any consequences arise, I am willing to bear that responsibility.", "22"],
                "22": ["Shen Tingfang", "(Produces a scroll from his sleeve) We are strangers who met by chance, connected through poetry. This scroll contains several poems by Ming dynasty literati inscribed for Zhihua Temple. Please accept it.", "23"],
                "23": ["Shen Tingfang", "Please follow the marked lines on the ground. They will guide you through experiencing Zhihua Temple within the realm of poetry.", null]
            },
            zh: {
                "1": ["觀眾", "（內心：好像旁邊有人在吟詩）", "2"],
                "2": ["沈廷芳", "萬叠西山擁帝靑，登樓一望雲冥冥。", "3"],
                "3": ["沈廷芳", "長空落日杳無際，塞鴈先秋到薊庭。", "4"],
                "4": ["沈廷芳", "京城秋高氣爽，最適合登樓遠眺。可惜沒有知己一同欣賞這景色。", "5"],
                "5": ["觀眾", "（內心：我曾背過一首詩，要不應和一下？）", "6"],
                "6": ["觀眾", "沙河燈火照山紅，歌鼓喧喧笑語中。", "7"],
                "7": ["觀眾", "為問少年心在否，角巾欹側鬢如蓬。", "8"],
                "8": ["沈廷芳", "（拍手）妙啊，這是蘇東坡赴杭州擔任監試時，登上鳳凰山望海樓有感而作。", "9"],
                "9": ["沈廷芳", "我也是杭州人。年少時有志於學問，尤其喜愛詩賦。蒙皇上恩典，入京師翰林院編修《明史》，研究前代君臣治亂的興衰之道。", "10"],
                "10": ["沈廷芳", "後來被派往山東擔任監察御史，負責賑災事務。最近因公事回京，便趁機尋訪古跡，探幽攬勝。", "11"],
                "11": ["觀眾", "（內心：也許他有智化寺的線索。)", "12"],
                "12": ["觀眾", "我也喜歡探訪古蹟。請問先生，可曾聽說過智化寺？", "13"],
                "13": ["沈廷芳", "前幾日剛好去了智化寺，竟看見寺內立著王振的木像。百姓們不明就裡，對他頂禮膜拜，實在是讓人痛心！", "14"],
                "14": ["沈廷芳", "於是我就寫了奏摺呈給乾隆皇帝，請求清除他的雕像，以正視聽，端正人心。", "15"],
                "15": ["觀眾", "（內心：原來他就是改變智化寺命運的清代御史沈廷芳！那王振又是誰？）", "16"],
                "16": ["觀眾", "晚輩才疏學淺，不太了解這些往事，願聽先生賜教。", "17"],
                "17": ["沈廷芳", "王振是明朝的一位宦官，篤信佛教。他捐出自己的宅院修建了智化寺，同時也用來供奉自己的祖先。", "18"],
                "18": ["沈廷芳", "王振深得明英宗寵信，後來專權誤國。正統十四年的土木堡之變（1449），他指揮失當，導致明軍全軍覆沒，自己也死於亂軍之中。", "19"],
                "19": ["沈廷芳", "自古以來，宦官一旦專權，百姓就要遭殃。如今智化寺的香火依舊旺盛，難道歷史已被遺忘？", "20"],
                "20": ["choice", ["a) 我認同沈先生的觀點，王振確實該被譴責。", "b) 請問先生，您這樣做，有沒有考慮過對智化寺的影響？"], {a: "21a", b: "21b"}],
                "21a": ["沈廷芳", "有識之士，所見略同。以史為鑑，正是我們這代人的責任。", "22"],
                "21b": ["沈廷芳", "寺廟本身沒有過錯，但難免受到牽連。若真有什麼影響，我也願意承擔這個責任。", "22"],
                "22": ["沈廷芳", "（從袖中抽出一卷軸）我們萍水相逢，因詩結緣。這卷軸裡收錄了幾首明代文人題詠智化寺的詩作，請你收下吧。", "23"],
                "23": ["沈廷芳", "請沿著地上的標線走，它會帶你在詩歌中細細品味智化寺的風韻。", null]
            },
            sc: {
                "1": ["观众", "（内心：好像旁边有人在吟诗）", "2"],
                "2": ["沈廷芳", "万叠西山拥帝青，登楼一望云冥冥。", "3"],
                "3": ["沈廷芳", "长空落日杳无际，塞雁先秋到蓟庭。", "4"],
                "4": ["沈廷芳", "京城秋高气爽，最适合登楼远眺。可惜没有知己一同欣赏这景色。", "5"],
                "5": ["观众", "（内心：我曾背过一首诗，要不应和一下？）", "6"],
                "6": ["观众", "沙河灯火照山红，歌鼓喧喧笑语中。", "7"],
                "7": ["观众", "为问少年心在否，角巾欹侧鬓如蓬。", "8"],
                "8": ["沈廷芳", "（拍手）妙啊，这是苏东坡赴杭州担任监试时，登上凤凰山望海楼有感而作。", "9"],
                "9": ["沈廷芳", "我也是杭州人。年少时有志于学问，尤其喜爱诗赋。蒙皇上恩典，入京师翰林院编修《明史》，研究前代君臣治乱的兴衰之道。", "10"],
                "10": ["沈廷芳", "后来被派往山东担任监察御史，负责赈灾事务。最近因公事回京，便趁机寻访古迹，探幽揽胜。", "11"],
                "11": ["观众", "（内心：也许他有智化寺的线索。）", "12"],
                "12": ["观众", "我也喜欢探访古迹。请问先生，可曾听说过智化寺？", "13"],
                "13": ["沈廷芳", "前几日刚好去了智化寺，竟看见寺内立着王振的木像。百姓们不明就里，对他顶礼膜拜，实在是让人痛心！", "14"],
                "14": ["沈廷芳", "于是我就写了奏折呈给乾隆皇帝，请求清除他的雕像，以正视听，端正人心。", "15"],
                "15": ["观众", "（内心：原来他就是改变智化寺命运的清代御史沈廷芳！那王振又是谁？）", "16"],
                "16": ["观众", "晚辈才疏学浅，不太了解这些往事，愿听先生赐教。", "17"],
                "17": ["沈廷芳", "王振是明朝的一位宦官，笃信佛教。他捐出自己的宅院修建了智化寺，同时也用来供奉自己的祖先。", "18"],
                "18": ["沈廷芳", "王振深得明英宗宠信，后来专权误国。正统十四年的土木堡之变（1449），他指挥失当，导致明军全军覆没，自己也死于乱军之中。", "19"],
                "19": ["沈廷芳", "自古以来，宦官一旦专权，百姓就要遭殃。如今智化寺的香火依旧旺盛，难道历史已被遗忘？", "20"],
                "20": ["choice", ["a) 我认同沈先生的观点，王振确实该被谴责。", "b) 请问先生，您这样做，有没有考虑过对智化寺的影响？"], {a: "21a", b: "21b"}],
                "21a": ["沈廷芳", "有识之士，所见略同。以史为鉴，正是我们这代人的责任。", "22"],
                "21b": ["沈廷芳", "寺庙本身没有过错，但难免受到牵连。若真有什么影响，我也愿意承担这个责任。", "22"],
                "22": ["沈廷芳", "（从袖中抽出一卷轴）我们萍水相逢，因诗结缘。这卷轴里收录了几首明代文人题咏智化寺的诗作，请你收下吧。", "23"],
                "23": ["沈廷芳", "请沿着地上的标线走，它会带你在诗歌中细细品味智化寺的风韵。", null]
            }
        },
        wang: {
            en: {
                "1": ["Audience", "(Inner monologue: The sound of music fills the air around me. I find myself amongst a group of monastic musicians. Seated before us is a man in splendid, ornate robes.)", "2"],
                "2": ["Wang Zhen", "(With a light sigh) Enough, enough. This \"Middle Court Melody\" is played at every recitation of the Avatamsaka Repentance Ritual. How can you still be so unfamiliar with this passage?", "3"],
                "3": ["Wang Zhen", "The pieces I taught you were drawn from court music—they are meant to be ancient, solemn, and dignified. Not a single mistake can be tolerated.", "4"],
                "4": ["Wang Zhen", "Tomorrow, His Majesty will grace us with a copy of the Yongle Northern Canon printed in the palace. I have already commissioned artisans to build an octagonal sutra cabinet in the Sutra Hall, perfectly sized to house the entire scriptures.", "5"],
                "5": ["Wang Zhen", "The performance during the thanking ceremony must not be as careless as today's. Practice diligently. I will return in one hour to check your progress.", "6"],
                "6": ["Audience", "(Inner: Court music... bestowal of scriptures... Could this man be Wang Zhen, the eunuch who found the Zhihua Temple?)", "7"],
                "7": ["Audience", "(Approaches the man, stopping behind him.) Please, my lord, a moment of your time. May I be so bold as to ask if the Nine-Dragon Coffered Ceiling in the Ten Thousand Buddha Hall has been completed?", "8"],
                "8": ["Wang Zhen", "(Slowly turns around, his gaze sweeping over the newcomer.) I have revealed the arrangements inside the Ten Thousand Buddha Hall to no one. How do you come to know of this coffered ceiling?", "9"],
                "9": ["choice", ["a) It feels as though I have seen the Ten Thousand Buddha Hall in a dream.", "b) I happened to learn of it while chatting with the artisans."], {a: "10a", b: "10b"}],
                "10a": ["Wang Zhen", "A monk should not speak untruths. If you have time for daydreams, you would be better spent practicing the music.", "11"],
                "10b": ["Wang Zhen", "The construction period is a mere two months, yet the artisans have leisure time to chat with you? If you have time to idle, you would be better spent practicing the music.", "11"],
                "11": ["Wang Zhen", "(Looking around alarmingly, and speaking in a low voice): Besides the artisans, you, me, and His Majesty, no one else should know of this coffered ceiling. Speak of it to no one else.", "12"],
                "12": ["Wang Zhen", "This coffered ceiling is not merely an architectural feature; it is a testament to karmic connection. Do you believe in karma?", "13"],
                "13": ["choice", ["a) Yes, I do.", "b) I don't quite understand."], {a: "14", b: "14"}],
                "14": ["Wang Zhen", "\"Karma\" is the primary cause from which all things arise; \"conditions\" are the various factors that help the primary cause come to fruition. All things in this world are born from the union of cause and conditions, and cease when those conditions disperse.", "15"],
                "15": ["Wang Zhen", "I come from humble beginnings. To make a living in my youth, I was selected to enter the palace as a eunuch. Within the palace, I started from scratch, learning to read and write.", "16"],
                "16": ["Wang Zhen", "A person like me, with no connections or support, who wished to survive the open and hidden struggles of the court, had no choice but to be scrupulously dutiful, walking on eggshells every single day.", "17"],
                "17": ["Wang Zhen", "As time passed, I gradually gained the trust of the late emperor, who then ordered me to serve the young crown prince in the Eastern Palace.", "18"],
                "18": ["Wang Zhen", "I spent my days and nights with the crown prince, caring for him attentively. When he grew a little older, I became his tutor, urging him on in his studies.", "19"],
                "19": ["Wang Zhen", "When the crown prince ascended the throne at the tender age of seven, he knew nothing of the palace's dangers. To repay the grace shown to me, I served His Majesty from dawn till dusk, protecting him and ensuring his safety.", "20"],
                "20": ["Wang Zhen", "Some say I am arrogant and monopolize power, that I persecute loyal ministers. Others wish nothing more than to see me gone. I admit, in this brutal arena of power, to survive, one sometimes cannot avoid necessary evils.", "21"],
                "21": ["Wang Zhen", "Everything I have today was bestowed upon me by the imperial family. To protect His Majesty, I would not hesitate to give my last ounce of strength, even should it cost me my life.", "22"],
                "22": ["Wang Zhen", "This coffered ceiling I designed: the five-clawed coiled dragon at its center symbolizes His Majesty. Encircling it are eight smaller swimming dragons, and on the outer ring are the Eight Auspicious Symbols of Tibetan Buddhism. Together, they guard and protect the coiled dragon at the heart.", "23"],
                "23": ["Wang Zhen", "Please, follow the marked lines on the floor. They will help you understand my intentions.", null]
            },
            zh: {
                "1": ["觀眾", "（內心獨白：四周樂聲悠揚，我置身於一群樂僧之間。前方端坐一位錦衣華服的男子。）", "2"],
                "2": ["王振", "（輕嘆一聲）罷了罷了，這首《中堂曲》是每次禮拜《華嚴寶懺》時必奏之樂，怎到現在還是如此生疏？", "3"],
                "3": ["王振", "我教給你們的這些曲目，源自宮廷雅樂，講究古樸莊重，半分差池也不容許。", "4"],
                "4": ["王振", "明日，聖上將賜宮中刊印的《永樂北藏》。我已命工匠在藏殿打造一座八角經櫥，正好安放這套經書。", "5"],
                "5": ["王振", "屆時謝恩演奏，萬萬不可如今日這般馬虎。你們仔細練習，一個時辰後我來檢查。", "6"],
                "6": ["觀眾", "（內心獨白：宮廷禮樂、御賜經書... 莫非此人就是創建智化寺的宦官王振？）", "7"],
                "7": ["觀眾", "請老公公留步。敢問萬佛閣中的九龍藻井，可已完工？", "8"],
                "8": ["王振", "（緩緩轉身，目光在觀眾身上打量片刻）萬佛閣內的陳設，我從未對外人道過。你是從何得知這座藻井的事？", "9"],
                "9": ["choice", ["a) 我好像在夢中見過萬佛閣。", "b) 我與工匠閒談時偶然得知。"], {a: "10a", b: "10b"}],
                "10a": ["王振", "出家人不打誑語。若有閒工夫做夢，不如多練練曲子。", "11"],
                "10b": ["王振", "工期不過兩個月，工匠還有空閒與你閒聊？若有工夫偷懶，不如多練練曲子。", "11"],
                "11": ["王振", "（男人環顧四週，壓低聲音說）這座藻井，除了工匠、你、我，便只有聖上知曉。切莫再與他人提起。", "12"],
                "12": ["王振", "那座藻井不僅是建築的一部分，更是“因緣”的見證。你相信因緣嗎？", "13"],
                "13": ["choice", ["a) 我相信。", "b）我不太明白。"], {a: "14", b: "14"}],
                "14": ["王振", "「因」是萬事生起的根本，「緣」是促成其成就的種種條件。世間萬物，無不因緣和合而生，緣盡則散。", "15"],
                "15": ["王振", "我出身寒微，年少時為求生計，被選入宮中為宦官。在宮中，我從認字開始，一步步學起。", "16"],
                "16": ["王振", "像我這樣無依無靠之人，要在宮廷的明爭暗鬥中立足，唯有謹言慎行，步步為營。", "17"],
                "17": ["王振", "日久天長，漸漸得先皇信任，命我入東宮，侍奉年幼的太子。", "18"],
                "18": ["王振", "我與太子朝夕相伴，悉心照料。待他稍長，又擔當教導之責，督促他讀書進學。", "19"],
                "19": ["王振", "太子登基時，年僅七歲，尚不知宮廷險惡。為報知遇之恩，我日夜守護在皇上身邊。", "20"],
                "20": ["王振", "有人說我專權跋扈，排擠忠良，也有人恨不得將我剷除。我承認，在這權力場上，為求自保，難免行「必要之惡」。", "21"],
                "21": ["王振", "我今日一切，皆為皇家所賜。為護皇上周全，縱使肝腦塗地，也在所不惜。", "22"],
                "22": ["王振", "我親手設計的這座藻井，中心為五爪金龍，象徵聖上；四周環繞八條游龍，外圍再飾以藏傳佛教的八吉祥寶，寓意眾星拱月，護佑中央。", "23"],
                "23": ["王振", "請沿著地上的標線走，它會幫您理解我的心意。", null]
            },
            sc: {
                "1": ["观众", "（内心独白：四周乐声悠扬，我置身于一群乐僧之间。前方端坐一位锦衣华服的男子。）", "2"],
                "2": ["王振", "（轻叹一声）罢了罢了，这首《中堂曲》是每次礼拜《华严宝忏》时必奏之乐，怎到现在还是如此生疏？", "3"],
                "3": ["王振", "我教给你们的这些曲目，源自宫廷雅乐，讲究古朴庄重，半分差池也不容许。", "4"],
                "4": ["王振", "明日，圣上将赐宫中刊印的《永乐北藏》。我已命工匠在藏殿打造一座八角经橱，正好安放这套经书。", "5"],
                "5": ["王振", "届时谢恩演奏，万万不可如今日这般马虎。你们仔细练习，一个时辰后我来检查。", "6"],
                "6": ["观众", "（内心独白：宫廷礼乐、御赐经书... 莫非此人就是创建智化寺的宦官王振？）", "7"],
                "7": ["观众", "请老公公留步。敢问万佛阁中的九龙藻井，可已完工？", "8"],
                "8": ["王振", "（缓缓转身，目光在观众身上打量片刻）万佛阁内的陈设，我从未对外人道过。你是从何得知这座藻井的事？", "9"],
                "9": ["choice", ["a) 我好像在梦中见过万佛阁。", "b) 我与工匠闲谈时偶然得知。"], {a: "10a", b: "10b"}],
                "10a": ["王振", "出家人不打诳语。若有闲工夫做梦，不如多练练曲子。", "11"],
                "10b": ["王振", "工期不过两个月，工匠还有空闲与你闲聊？若有工夫偷懒，不如多练练曲子。", "11"],
                "11": ["王振", "（男人环顾四周，压低声音说）这座藻井，除了工匠、你、我，便只有圣上知晓。切莫再与他人提起。", "12"],
                "12": ["王振", "那座藻井不仅是建筑的一部分，更是“因缘”的见证。你相信因缘吗？", "13"],
                "13": ["choice", ["a) 我相信。", "b）我不太明白。"], {a: "14", b: "14"}],
                "14": ["王振", "「因」是万事生起的根本，「缘」是促成其成就的种种条件。世间万物，无不因缘和合而生，缘尽则散。", "15"],
                "15": ["王振", "我出身寒微，年少时为求生计，被选入宫中为宦官。在宫中，我从认字开始，一步步学起。", "16"],
                "16": ["王振", "像我这样无依无靠之人，要在宫廷的明争暗斗中立足，唯有谨言慎行，步步为营。", "17"],
                "17": ["王振", "日久天长，渐渐得先皇信任，命我入东宫，侍奉年幼的太子。", "18"],
                "18": ["王振", "我与太子朝夕相伴，悉心照料。待他稍长，又担当教导之责，督促他读书进学。", "19"],
                "19": ["王振", "太子登基时，年仅七岁，尚不知宫廷险恶。为报知遇之恩，我日夜守护在皇上身边。", "20"],
                "20": ["王振", "有人说我专权跋扈，排挤忠良，也有人恨不得将我铲除。我承认，在这权力场上，为求自保，难免行「必要之恶」。", "21"],
                "21": ["王振", "我今日一切，皆为皇家所赐。为护皇上周全，纵使肝脑涂地，也在所不惜。", "22"],
                "22": ["王振", "我亲手设计的这座藻井，中心为五爪金龙，象征圣上；四周环绕八条游龙，外围再饰以藏传佛教的八吉祥宝，寓意众星拱月，护佑中央。", "23"],
                "23": ["王振", "请沿着地上的标线走，它会帮您理解我的心意。", null]
            }
        }
    };

    let isInteracting = false; 
    let posX = 1300, posY = 700, speed = 12;
    let activeNode = null, currentStep = "0", currentLang = 'en';

    let keys = {};
    document.addEventListener('keydown', e => { keys[e.code] = true; });
    document.addEventListener('keyup', e => { keys[e.code] = false; });

    function startMove(dir) {
        if (dir === 'up') keys['ArrowUp'] = true;
        if (dir === 'down') keys['ArrowDown'] = true;
        if (dir === 'left') keys['ArrowLeft'] = true;
        if (dir === 'right') keys['ArrowRight'] = true;
    }
    function stopMove(dir) {
        if (dir === 'up') keys['ArrowUp'] = false;
        if (dir === 'down') keys['ArrowDown'] = false;
        if (dir === 'left') keys['ArrowLeft'] = false;
        if (dir === 'right') keys['ArrowRight'] = false;
    }

    function frame() {
        if (!isInteracting) {
            if (keys['ArrowUp'] || keys['KeyW']) posY -= speed;
            if (keys['ArrowDown'] || keys['KeyS']) posY += speed;
            if (keys['ArrowLeft'] || keys['KeyA']) posX -= speed;
            if (keys['ArrowRight'] || keys['KeyD']) posX += speed;

            posX = Math.max(0, Math.min(posX, 1507 - 34));
            posY = Math.max(0, Math.min(posY, 765 - 34));

            document.getElementById('player').style.left = posX + 'px';
            document.getElementById('player').style.top = posY + 'px';
            document.getElementById('debug').innerText = `X: ${Math.round(posX)}, Y: ${Math.round(posY)}`;
            
            checkProximity();
        }
        requestAnimationFrame(frame);
    }

    function checkProximity() {
        let found = false;
        let activeTrigger = null;
        
        hotspots.forEach(node => {
            const dist = Math.sqrt((posX - node.x)**2 + (posY - node.y)**2);
            if (dist < 85) {
                found = true;
                activeTrigger = node;
            }
        });

        const btn = document.getElementById('interact-btn');
        if (found) {
            btn.style.display = 'block';
            // Overwriting onclick completely every frame can cause it to break. We set it securely once.
            btn.onclick = function() { executeInteraction(activeTrigger); };
        } else {
            btn.style.display = 'none';
        }
    }

    // THIS REPLACES LAUNCH() to guarantee click registration
    function executeInteraction(node) {
        isInteracting = true; 
        activeNode = node;
        document.getElementById('interact-btn').style.display = 'none'; // hide button while interacting
        
        if (node.type === 'diag') {
            currentStep = "0"; 
            document.getElementById('diag-overlay').style.display = 'flex'; 
            renderDiag();
        } else if (node.type === 'media') {
            document.getElementById('media-frame').src = node.url; 
            document.getElementById('media-nav').style.display = 'none';
            document.getElementById('media-overlay').style.display = 'flex';
        } else if (node.type === 'seq') {
            document.getElementById('media-frame').src = node.id === 'wanfo_seq' ? "https://drive.google.com/file/d/1-5t-9Wgu9cJ60Ki2YeoQsiyuIpFxlKp2/preview" : "https://drive.google.com/file/d/1R7Nkooasa-kw75eISv70DAefpRER1Msk/preview";
            document.getElementById('media-nav').style.display = 'block';
            document.getElementById('media-next-btn').innerText = "Next"; 
            document.getElementById('media-overlay').style.display = 'flex';
        } else if (node.type === 'external') {
            document.getElementById('media-frame').src = "https://drive.google.com/file/d/1AZFtmEa2jMJHr31Wm85bXk5OYFvwaDB6/preview";
            document.getElementById('media-nav').style.display = 'block';
            document.getElementById('media-next-btn').innerText = "Open 3D Tour";
            document.getElementById('media-overlay').style.display = 'flex';
        }
    }

    function renderDiag() {
        const textArea = document.getElementById('diag-text');
        const choiceArea = document.getElementById('diag-choices');
        const nextBtn = document.getElementById('diag-next');
        const speaker = document.getElementById('diag-speaker');

        choiceArea.innerHTML = ""; 
        nextBtn.style.display = "none";

        if (currentStep === "0") {
            speaker.innerText = "System";
            textArea.innerText = "Please select your language / 請選擇語言 / 请选择语言";
            addChoice("English", () => { currentLang = 'en'; currentStep = "1"; renderDiag(); });
            addChoice("繁體中文", () => { currentLang = 'zh'; currentStep = "1"; renderDiag(); });
            addChoice("简体中文", () => { currentLang = 'sc'; currentStep = "1"; renderDiag(); });
            return;
        }

        const data = scripts[activeNode.id][currentLang][currentStep];
        document.getElementById('diag-box').style.borderTopColor = `var(--${activeNode.id})`;

        if (!data) { closeAll(); return; }

        if (data[0] === 'choice') {
            textArea.innerText = "";
            data[1].forEach((opt, i) => {
                addChoice(opt, () => {
                    currentStep = (i === 0) ? data[2].a : data[2].b;
                    renderDiag();
                });
            });
        } else {
            speaker.innerText = data[0];
            const content = data[1];
            textArea.innerHTML = (content.includes("inner") || content.includes("Inner") || content.includes("內心") || content.includes("内心")) ? `<div class="inner">${content}</div>` : content;
            
            nextBtn.style.display = "block";
            
            if (data[2] === null) {
                nextBtn.innerText = currentLang === 'en' ? "Finish" : (currentLang === 'zh' ? "結束" : "结束");
                nextBtn.onclick = () => closeAll();
            } else {
                nextBtn.innerText = currentLang === 'en' ? "Next" : "下一步";
                nextBtn.onclick = () => { currentStep = data[2]; renderDiag(); };
            }
        }
    }

    function handleMediaNext() {
        if (activeNode.id === 'wanfo_seq') {
            document.getElementById('media-frame').src = "https://drive.google.com/file/d/1yUNvO6yW68Wzbe_qGWHE_1mTvNdV_tLc/preview";
            document.getElementById('media-nav').style.display = 'none';
        } else if (activeNode.id === 'soundscape') {
            document.getElementById('media-frame').src = "https://drive.google.com/file/d/1VfaZmNbn-2FLCUTnFlH8iRqfqHT7R_Jk/preview";
            document.getElementById('media-nav').style.display = 'none';
        } else if (activeNode.id === 'ceiling_3d') {
            window.open("https://museumverse.viewin360.co/share/collection/7DFdr?logo=-1&info=0&fs=1&vr=1&sd=1&initload=0&thumbs=1", "_blank");
            closeAll();
        }
    }

    function addChoice(txt, cb) {
        const b = document.createElement('div'); 
        b.className = 'btn-choice'; b.innerText = txt; b.onclick = cb;
        document.getElementById('diag-choices').appendChild(b);
    }

    function closeAll() {
        document.getElementById('diag-overlay').style.display = 'none'; 
        document.getElementById('media-overlay').style.display = 'none';
        document.getElementById('media-frame').src = ""; 
        isInteracting = false; 
        keys = {}; 
        window.focus(); 
    }
</script>
</body>
</html>